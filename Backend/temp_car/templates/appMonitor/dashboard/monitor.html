{% extends 'appMonitor/baseDashboard.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}
Monitoreo
{% endblock %}

{% block styles %}
<style>
    .carousel-wrapper {
        position: relative;
    }

    .carousel-inner {
        position: relative;
        width: 100%;
        height: 100%;
    }

    .carousel-item {
        position: absolute;
        width: 100%;
        height: 100%;
        opacity: 0;
        visibility: hidden;
        transition: opacity 1s ease-in-out, visibility 1s ease-in-out;
    }

    .carousel-item.active {
        opacity: 1;
        visibility: visible;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .carousel-control-prev,
    .carousel-control-next {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 50px;
        height: 50px;
        border: none !important;
        border-radius: 50%;
        z-index: 50;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .carousel-control-prev {
        left: 20px;
    }

    .carousel-control-next {
        right: 20px;
    }

    .carousel-control-prev:hover,
    .carousel-control-next:hover {
        transform: translateY(-50%) scale(1.1);
    }

    .carousel-control-prev-icon,
    .carousel-control-next-icon {
        background-image: none !important;
    }

    .carousel-control-prev-icon {
        background-image: url('../../../static/assets/img/caret-left-fill.svg') !important;
    }

    .carousel-control-next-icon {
        background-image: url('../../../static/assets/img/caret-right-fill.svg') !important;
    }

    .spinner-overlay {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 999;
        justify-content: center;
        align-items: center;
        border-radius: 12px;
    }

    .spinner-overlay.active {
        display: flex;
    }

    .spinner {
        border: 4px solid #395897;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="w-full h-full flex items-center justify-center -mt-10 ">
    <div class="w-full h-[80vh] bg-white rounded-2xl shadow-lg" style="max-width: 95%;">
        <div class="w-full h-full flex flex-col">
            <div class="carousel-wrapper w-full h-full rounded-2xl relative overflow-visible" 
                x-data="monitorApp([
                    {% for collar in collares %}
                    { idCollar: '{{ collar.idCollar }}', nombre: '{{ collar.nombre }}' }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ])" 
                @alpine:init="init()">
                <div class="carousel-inner w-full h-full">
                    <template x-for="(collar, index) in collares" :key="collar.idCollar">
                        <div class="carousel-item w-full h-full flex flex-col" :class="{ 'active': index === currentIndex }">
                            <!-- Sección superior: datos del collar -->
                            <div class="flex justify-center items-start px-2 py-2 w-full " >
                                <div class="w-full">
                                    <div class="datos-concurrentes w-full flex  justify-center " :data-id="collar.idCollar">
                                        <div x-show="!loadingData[collar.idCollar]" class="bg-white w-[25%] border-2 border-blue-500 rounded-lg  shadow-md p-2">
                                            <h3 class="text-center text-[1rem] font-bold text-blue-600 mb-2">Último registro del collar <span x-text="collar.idCollar"></span></h3>
                                            <div class="text-left space-y-1 pl-2">
                                                <p class="text-gray-700"><span class="font-semibold">Nombre:</span> <span x-text="collareData[collar.idCollar]?.nombre || '-'"></span></p>
                                                <p class="text-gray-700"><span class="font-semibold">Temperatura:</span> <span x-text="collareData[collar.idCollar]?.temperatura || '-'"></span>°C</p>
                                                <p class="text-gray-700"><span class="font-semibold">Pulsaciones:</span> <span x-text="collareData[collar.idCollar]?.pulsaciones || '-'"></span> bpm</p>
                                                <p class="text-gray-700 "><span class="font-semibold">Fecha:</span> <span x-text="collareData[collar.idCollar]?.fecha_registro || '-'"></span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sección inferior: gráfico -->
                            <div class="flex justify-center items-center px-8 mt-2  w-full h-[100%]" >
                                <div class="w-full h-[100%] ">
                                    <div class="spinner-overlay" :class="{ 'active': showSpinner[collar.idCollar] }">
                                        <div class="spinner"></div>
                                    </div>
                                    <div :data-chart-id="collar.idCollar" class="w-full h-full flex justify-center items-center" >
                                        <!-- SVG se genera aquí -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Botones de navegación -->
                <button class="carousel-control-prev" type="button" @click="previous()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="carousel-control-next" type="button" @click="next()">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <i class="fas fa-chevron-right"></i>
                </button>

                <!-- Indicadores -->
                <div class="carousel-indicators flex justify-center items-center gap-2 pb-4">
                    <template x-for="(collar, index) in collares" :key="collar.idCollar">
                        <button type="button" @click="goToSlide(index)"
                            :class="{ 'active': index === currentIndex }" 
                            :aria-current="index === currentIndex"
                            :aria-label="'Slide ' + (index + 1)">
                        </button>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
    window.monitorApp = function(collares = []) {
        return {
            currentIndex: 0,
            collares: collares,
            showSpinner: {},
            collareData: {},
            loadingData: {},
            
            init() {
                this.collares.forEach(collar => {
                    this.showSpinner[collar.idCollar] = false;
                    this.collareData[collar.idCollar] = {};
                    this.loadingData[collar.idCollar] = false;
                });
                
                this.$nextTick(() => {
                    this.updateChart();
                    setInterval(() => {
                        this.updateChart();
                        this.next();
                    }, 8000);
                });
            },
            
            generateSVGChart(temps, pulses) {
                const width = 800, height = 400;
                const padding = { top: 40, right: 40, bottom: 40, left: 60 };
                const chartWidth = width - padding.left - padding.right;
                const chartHeight = height - padding.top - padding.bottom;
                
                if (!temps || !pulses || temps.length === 0) {
                    return `<svg width="100%" height="100%" color: #193b80; font-family: Arial, sans-serif;  viewBox="0 0 ${width} ${height}">
                        <text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle">Sin datos</text>
                    </svg>`;
                }
                
                const allVals = [...temps, ...pulses];
                const minTemp = Math.min(...temps) - 1;
                const maxTemp = Math.max(...temps) + 1;
                const minPulse = Math.min(...pulses) - 5;
                const maxPulse = Math.max(...pulses) + 5;
                
                const tempRange = maxTemp - minTemp || 1;
                const pulseRange = maxPulse - minPulse || 1;
                
                const tempPoints = temps.map((val, i) => {
                    const x = padding.left + (i / (temps.length - 1 || 1)) * chartWidth;
                    const y = padding.top + chartHeight - ((val - minTemp) / tempRange) * chartHeight;
                    return { x, y };
                });
                
                const pulsePoints = pulses.map((val, i) => {
                    const x = padding.left + (i / (pulses.length - 1 || 1)) * chartWidth;
                    const y = padding.top + chartHeight - ((val - minPulse) / pulseRange) * chartHeight;
                    return { x, y };
                });
                
                // Función para generar curva Bezier suave
                const generateCurve = (points) => {
                    if (points.length < 2) return '';
                    
                    let path = `M ${points[0].x} ${points[0].y}`;
                    
                    for (let i = 1; i < points.length; i++) {
                        const curr = points[i];
                        const prev = points[i - 1];
                        
                        // Control point
                        const cpx = (prev.x + curr.x) / 2;
                        const cpy = (prev.y + curr.y) / 2;
                        
                        path += ` Q ${cpx} ${cpy} ${curr.x} ${curr.y}`;
                    }
                    return path;
                };
                
                const tempPath = generateCurve(tempPoints);
                const pulsePath = generateCurve(pulsePoints);
                
                let svg = `<svg width="70%" height="100%" display: flex; justify-content: center; align-items: center;  viewBox="0 0 ${width} ${height} " >
                    <defs>
                        <linearGradient id="grad-temp" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:rgba(255,99,132,0.3);stop-opacity:1" />
                            <stop offset="100%" style="stop-color:rgba(255,99,132,0);stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="grad-pulse" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:rgba(54,162,235,0.3);stop-opacity:1" />
                            <stop offset="100%" style="stop-color:rgba(54,162,235,0);stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    
                    <!-- Temperatura área -->
                    <path d="${tempPath} L ${tempPoints[tempPoints.length-1].x} ${padding.top + chartHeight} L ${padding.left} ${padding.top + chartHeight} Z" 
                        fill="url(#grad-temp)" stroke="none"/>
                    
                    <!-- Pulsaciones área -->
                    <path d="${pulsePath} L ${pulsePoints[pulsePoints.length-1].x} ${padding.top + chartHeight} L ${padding.left} ${padding.top + chartHeight} Z" 
                        fill="url(#grad-pulse)" stroke="none"/>
                    
                    <!-- Líneas suavizadas -->
                    <path d="${tempPath}" fill="none" stroke="rgba(255, 99, 132, 1)" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="${pulsePath}" fill="none" stroke="rgba(54, 162, 235, 1)" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>
                    `;
                
                // Puntos temperatura
                tempPoints.forEach(p => {
                    svg += `<circle cx="${p.x}" cy="${p.y}" r="2" fill="rgba(255, 99, 132, 1)" stroke="white" stroke-width="1"/>`;
                });
                
                // Puntos pulsaciones
                pulsePoints.forEach(p => {
                    svg += `<circle cx="${p.x}" cy="${p.y}" r="2" fill="rgba(54, 162, 235, 1)" stroke="white" stroke-width="1"/>`;
                });
                
                svg += `
                    <!-- Ejes -->
                    <line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${padding.top + chartHeight}" stroke="#64758f" stroke-width="1"/>
                    <line x1="${padding.left}" y1="${padding.top + chartHeight}" x2="${width - padding.right}" y2="${padding.top + chartHeight}" stroke="#3a5885" stroke-width="1"/>
                    
                    <!-- Legendas -->
                    <text x="${width - padding.left - 100}" y="${padding.top + 10}" font-size="12" fill="rgba(255, 99, 132, 1)">● Temp(°C)</text>
                    <text x="${width - padding.left - 100}" y="${padding.top + 25}" font-size="12" fill="rgba(54, 162, 235, 1)">● Pulse(bpm)</text>
                </svg>`;
                
                return svg;
            },
            
            async updateChart() {
                if (!this.collares[this.currentIndex]) return;
                
                const collar = this.collares[this.currentIndex];
                this.showSpinner[collar.idCollar] = true;
                this.loadingData[collar.idCollar] = true;
                
                try {
                    const response = await fetch(`/monitor/datos/${collar.idCollar}/`);
                    if (!response.ok) throw new Error('Error en la API');
                    
                    const data = await response.json();
                    const collareInfo = data.collar_info;
                    const registros = data.ultimos_registros;
                    
                    this.collareData[collar.idCollar] = collareInfo;
                    
                    const temperaturas = registros.map(item => parseFloat(item.temperatura));
                    const pulsaciones = registros.map(item => parseFloat(item.pulsaciones));
                    
                    const chartContainer = document.querySelector(`[data-chart-id="${collar.idCollar}"]`);
                    if (chartContainer) {
                        chartContainer.innerHTML = this.generateSVGChart(temperaturas, pulsaciones);
                    }
                    
                    this.showSpinner[collar.idCollar] = false;
                    this.loadingData[collar.idCollar] = false;
                } catch (error) {
                    this.showSpinner[collar.idCollar] = false;
                    this.loadingData[collar.idCollar] = false;
                    //alert('Error al cargar los datos: ' + error.message);
                }
            },
            
            previous() {
                this.currentIndex = (this.currentIndex - 1 + this.collares.length) % this.collares.length;
                this.updateChart();
            },
            
            next() {
                this.currentIndex = (this.currentIndex + 1) % this.collares.length;
                this.updateChart();
            },
            
            goToSlide(index) {
                this.currentIndex = index;
                this.updateChart();
            }
        };
    };
</script>
{% endblock %}