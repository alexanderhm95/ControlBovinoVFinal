{% extends 'appMonitor/baseDashboard.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}
Temperatura
{% endblock %}

{% block styles %}
<style>
  

    .carousel-inner {
        position: relative;
        width: 100%;
        height: 100%;
    }

    .carousel-item {
        position: absolute;
        width: 100%;
        height: 100%;
        opacity: 0;
        visibility: hidden;
        transition: opacity 1s ease-in-out, visibility 1s ease-in-out;
    }

    .carousel-item.active {
        opacity: 1;
        visibility: visible;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .carousel-control-prev,
    .carousel-control-next {
        position: absolute;
        top: 40%;
        transform: translateY(-20%);
        width: 50px;
        height: 50px;
        border: none !important;
        border-radius: 50%;
        z-index: 50;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .carousel-control-prev {
        left: 20px;
    }

    .carousel-control-next {
        right: 20px;
    }

    .carousel-control-prev:hover,
    .carousel-control-next:hover {
        transform: translateY(-20%) scale(1.1);
    }

    .carousel-control-prev-icon,
    .carousel-control-next-icon {
        background-image: none !important;
    }

    .carousel-control-prev-icon {
        background-image: url('../../../static/assets/img/caret-left-fill.svg') !important;
    }

    .carousel-control-next-icon {
        background-image: url('../../../static/assets/img/caret-right-fill.svg') !important;
    }

    .spinner-overlay {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.85);
        z-index: 999;
        justify-content: center;
        align-items: center;
        border-radius: 12px;
    }

    .spinner-overlay.active {
        display: flex;
    }

    .spinner {
        border: 4px solid #e5e7eb;
        border-top: 4px solid #fbbf24;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="w-full flex flex-col -px-6">
    <!-- Sección del Carousel -->
    <div class="w-full h-[60vh]" >
        <div class="w-full h-full flex flex-col items-center justify-center relative">
            <div class=" w-full h-full" 
                x-data="temperatureApp([
                    {% for collar in collares %}
                    { idCollar: '{{ collar.idCollar }}', nombre: '{{ collar.nombre }}' }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ])" 
                @alpine:init="init()">
                <div class="carousel-inner w-[100%] h-[80%]">
                    <template x-for="(collar, index) in collares" :key="collar.idCollar">
                        <div class="carousel-item w-full h-full flex items-center justify-center" :class="{ 'active': index === currentIndex }">
                            <div class="w-full h-full flex flex-col justify-center items-center px-8 py-6 relative" >
                                <div class="spinner-overlay" :class="{ 'active': showSpinner[collar.idCollar] }">
                                    <div class="spinner"></div>
                                </div>
                                <div :data-chart-id="collar.idCollar" class="w-full h-full flex items-center justify-center">
                                    <!-- SVG se genera aquí -->
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Botones de navegación -->
                <button class="carousel-control-prev" type="button" @click="previous()">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="carousel-control-next" type="button" @click="next()">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <i class="fas fa-chevron-right"></i>
                </button>

                <!-- Indicadores -->
                <div class="carousel-indicators flex justify-center items-center gap-2 pb-2">
                    <template x-for="(collar, index) in collares" :key="collar.idCollar">
                        <button type="button" @click="goToSlide(index)"
                            :class="{ 'active': index === currentIndex }" 
                            :aria-current="index === currentIndex"
                            :aria-label="'Slide ' + (index + 1)">
                        </button>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Sección de la Tabla -->
    <div class="w-full flex justify-center -mt-[6rem] mb-[6rem]">
        <div class="w-full bg-white rounded-2xl shadow-lg overflow-hidden" style="max-width: 95%;">
            <div class="p-6">
                <h3 class="text-2xl font-bold text-center text-gray-800 mb-6">Tabla de Temperaturas</h3>
                
                <!-- Tabla Responsiva -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gradient-to-r from-yellow-400 to-yellow-300 text-black">
                                <th class="px-6 py-3 text-left font-semibold border-b-2 border-yellow-500">Collar</th>
                                <th class="px-6 py-3 text-left font-semibold border-b-2 border-yellow-500">Nombre</th>
                                <th class="px-6 py-3 text-center font-semibold border-b-2 border-yellow-500">Fecha de Lectura</th>
                                <th class="px-6 py-3 text-center font-semibold border-b-2 border-yellow-500">Temperatura</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            {% for reporte in reportes %}
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-6 py-4 text-gray-700">{{ reporte.id_Lectura.id_Bovino.idCollar }}</td>
                                <td class="px-6 py-4 text-gray-700">{{ reporte.id_Lectura.id_Bovino.nombre }}</td>
                                <td class="px-6 py-4 text-center text-gray-600">{{ reporte.fecha_lectura|date:"d-m-Y" }} {{ reporte.hora_lectura|time:"H:i" }}</td>
                                <td class="px-6 py-4 text-center">
                                    <span class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-lg font-semibold">
                                        {{ reporte.id_Lectura.id_Temperatura.valor }}°C
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="px-6 py-8 text-center text-gray-500">No hay reportes disponibles.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Paginación -->
                {% if reportes.paginator.num_pages > 1 %}
                <nav aria-label="Page navigation" class="mt-6">
                    <ul class="flex justify-center items-center gap-2 flex-wrap">
                        {% if reportes.has_previous %}
                        <li>
                            <a href="?page=1" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                                &laquo; Primera
                            </a>
                        </li>
                        <li>
                            <a href="?page={{ reportes.previous_page_number }}" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                                Anterior
                            </a>
                        </li>
                        {% endif %}
                        
                        <li class="px-3 py-2 bg-gray-200 text-gray-700 rounded">
                            Página {{ reportes.number }} de {{ reportes.paginator.num_pages }}
                        </li>
                        
                        {% if reportes.has_next %}
                        <li>
                            <a href="?page={{ reportes.next_page_number }}" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                                Próximo
                            </a>
                        </li>
                        <li>
                            <a href="?page={{ reportes.paginator.num_pages }}" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                                Último &raquo;
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
    window.temperatureApp = function(collares = []) {
        return {
            currentIndex: 0,
            collares: collares,
            showSpinner: {},
            
            init() {
                this.collares.forEach(collar => {
                    this.showSpinner[collar.idCollar] = false;
                });
                
                this.$nextTick(() => {
                    this.updateChart();
                    setInterval(() => {
                        this.updateChart();
                        this.next();
                    }, 8000);
                });
            },
            
            generateSVGChart(data) {
                const width = 800, height = 400;
                const padding = { top: 40, right: 40, bottom: 40, left: 60 };
                const chartWidth = width - padding.left - padding.right;
                const chartHeight = height - padding.top - padding.bottom;
                
                if (!data || data.length === 0) {
                    return `<svg width="100%" height="100%" viewBox="0 0 ${width} ${height}">
                        <text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle">Sin datos</text>
                    </svg>`;
                }
                
                const minVal = Math.min(...data) - 1;
                const maxVal = Math.max(...data) + 1;
                const range = maxVal - minVal || 1;
                
                const points = data.map((val, i) => {
                    const x = padding.left + (i / (data.length - 1 || 1)) * chartWidth;
                    const y = padding.top + chartHeight - ((val - minVal) / range) * chartHeight;
                    return { x, y, val };
                });
                
                // Función para generar curva Bezier suave
                const generateCurve = (pts) => {
                    if (pts.length < 2) return '';
                    
                    let path = `M ${pts[0].x} ${pts[0].y}`;
                    
                    for (let i = 1; i < pts.length; i++) {
                        const curr = pts[i];
                        const prev = pts[i - 1];
                        
                        // Control point para curva suave
                        const cpx = (prev.x + curr.x) / 2;
                        const cpy = (prev.y + curr.y) / 2;
                        
                        path += ` Q ${cpx} ${cpy} ${curr.x} ${curr.y}`;
                    }
                    return path;
                };
                
                const pathD = generateCurve(points);
                
                let svg = `<svg width="100%" height="100%" viewBox="0 0 ${width} ${height}" style="background: white;">
                    <defs>
                        <linearGradient id="grad-temp" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:rgba(255,99,132,0.3);stop-opacity:1" />
                            <stop offset="100%" style="stop-color:rgba(255,99,132,0);stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    
                    <path d="${pathD} L ${points[points.length-1].x} ${padding.top + chartHeight} L ${padding.left} ${padding.top + chartHeight} Z" 
                        fill="url(#grad-temp)" stroke="none"/>
                    
                    <path d="${pathD}" 
                        fill="none" stroke="rgba(255, 99, 132, 1)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>`;
                
                points.forEach(p => {
                    svg += `<circle cx="${p.x}" cy="${p.y}" r="4" fill="rgba(255, 99, 132, 1)" stroke="white" stroke-width="2"/>`;
                });
                
                svg += `
                    <line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${padding.top + chartHeight}" stroke="#d1d5db" stroke-width="1"/>
                    <line x1="${padding.left}" y1="${padding.top + chartHeight}" x2="${width - padding.right}" y2="${padding.top + chartHeight}" stroke="#d1d5db" stroke-width="1"/>
                    <text x="${padding.left - 10}" y="${padding.top + 5}" text-anchor="end">${maxVal.toFixed(1)}</text>
                    <text x="${padding.left - 10}" y="${padding.top + chartHeight + 5}" text-anchor="end">${minVal.toFixed(1)}</text>
                    <text x="${width - padding.right - 20}" y="${padding.top + 20}" font-size="14" font-weight="bold" text-anchor="end" fill="rgba(255, 99, 132, 1)">● Temp(°C)</text>
                </svg>`;
                
                return svg;
            },
            
            async updateChart() {
                if (!this.collares[this.currentIndex]) return;
                
                const collar = this.collares[this.currentIndex];
                this.showSpinner[collar.idCollar] = true;
                
                try {
                    const response = await fetch(`/monitor/datos/${collar.idCollar}/`);
                    if (!response.ok) throw new Error('Error en la API');
                    
                    const data = await response.json();
                    const registros = data.ultimos_registros;
                    const temperaturas = registros.map(item => parseFloat(item.temperatura));
                    
                    const chartContainer = document.querySelector(`[data-chart-id="${collar.idCollar}"]`);
                    if (chartContainer) {
                        chartContainer.innerHTML = this.generateSVGChart(temperaturas);
                    }
                    
                    this.showSpinner[collar.idCollar] = false;
                } catch (error) {
                    this.showSpinner[collar.idCollar] = false;
                    alert('Error al cargar los datos: ' + error.message);
                }
            },
            
            previous() {
                this.currentIndex = (this.currentIndex - 1 + this.collares.length) % this.collares.length;
                this.updateChart();
            },
            
            next() {
                this.currentIndex = (this.currentIndex + 1) % this.collares.length;
                this.updateChart();
            },
            
            goToSlide(index) {
                this.currentIndex = index;
                this.updateChart();
            }
        };
    };
</script>
{% endblock %}
